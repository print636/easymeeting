# EasyMeeting 项目整体梳理报告

## 📋 项目概述

**项目名称**: EasyMeeting（易会议）  
**项目类型**: 在线视频会议系统  
**技术栈**: Spring Boot 2.7.18 + MyBatis + MySQL + Redis/ RabbitMQ + Netty WebSocket  
**开发语言**: Java 1.8

---

## 🏗️ 项目架构

### 1. 分层架构
```
com.easymeeting/
├── controller/      # 控制器层（REST API）
├── service/         # 服务接口层
├── service/impl/    # 服务实现层
├── mappers/         # 数据访问层（MyBatis）
├── entity/          # 实体层
│   ├── po/         # 持久化对象
│   ├── dto/        # 数据传输对象
│   ├── vo/         # 视图对象
│   ├── query/      # 查询对象
│   ├── enums/      # 枚举类
│   └── constants/  # 常量类
├── utils/          # 工具类
├── config/         # 配置类
├── redis/          # Redis 组件
├── websocket/      # WebSocket 相关
│   ├── netty/      # Netty WebSocket 实现
│   └── message/    # 消息处理（Redis/RabbitMQ）
├── exception/      # 异常处理
├── aspect/         # AOP 切面
└── annotation/     # 自定义注解
```

---

## 🔧 核心功能模块

### 1. 用户管理模块
**Controller**: `AccountController`, `AdminController`  
**Service**: `UserInfoService`  
**功能**:
- ✅ 用户注册/登录
- ✅ 用户信息管理（头像上传、信息修改）
- ✅ 密码修改
- ✅ 管理员功能（用户列表、状态管理、强制下线）
- ✅ Token 认证机制

**关键实现**:
- 使用 Redis 存储 Token 信息
- 支持单点登录检测（通过 `lastLoginTime` 和 `lastOffTime` 判断）
- 头像上传使用 FFmpeg 生成缩略图
- 强制下线功能支持 WebSocket 消息通知

### 2. 会议管理模块
**Controller**: `MeetingInfoController`, `MeetingReserveController`, `AdminMeetingController`  
**Service**: `MeetingInfoService`, `MeetingReserveService`, `MeetingMemberService`  
**功能**:
- ✅ 快速会议（即时创建）
- ✅ 预约会议（定时会议）
- ✅ 会议加入/退出
- ✅ 会议邀请
- ✅ 会议成员管理
- ✅ 会议状态管理（进行中/已结束）
- ✅ 会议密码保护

**关键实现**:
- 会议信息存储在 MySQL
- 会议成员实时状态存储在 Redis（`meeting:room:{meetingId}`）
- 支持 WebRTC 点对点通信（通过 WebSocket 传递 Peer 连接信息）

### 3. 聊天消息模块
**Controller**: `ChatController`  
**Service**: `MeetingChatMessageService`  
**功能**:
- ✅ 文本消息发送
- ✅ 媒体文件上传（图片/视频）
- ✅ 消息历史查询
- ✅ 消息分页加载
- ✅ 私聊/群聊支持

**关键实现**:
- 消息表按月分表存储（`TableSplitUtils`）
- 使用雪花算法生成消息 ID（`SnowFlakeUtils`）
- 图片统一转为 JPG，视频转为 MP4
- 自动生成缩略图/封面图（`FFmpegUtils`）
- 支持消息状态管理（发送中/已发送）

### 4. 文件管理模块
**Controller**: `FileController`  
**功能**:
- ✅ 文件资源获取（支持 Range 请求，视频流式播放）
- ✅ 文件下载
- ✅ 用户头像获取
- ✅ 缩略图支持

**关键实现**:
- 文件按月份分目录存储
- 支持 HTTP Range 请求（断点续传、视频流式播放）
- 图片缓存策略（30天）
- 默认头像回退机制

### 5. 好友/联系人模块
**Controller**: `UserContactController`  
**Service**: `UserContactService`, `UserContactApplyService`  
**功能**:
- ✅ 好友申请
- ✅ 好友申请处理（同意/拒绝）
- ✅ 好友列表查询
- ✅ 好友搜索

### 6. WebSocket 实时通信模块
**核心类**: `NettyWebSocketStarter`, `HandlerWebSocket`, `ChannelContextUtils`  
**功能**:
- ✅ WebSocket 连接管理
- ✅ 实时消息推送
- ✅ 会议房间管理
- ✅ 用户在线状态管理

**关键实现**:
- 使用 Netty 实现 WebSocket 服务器
- 连接信息存储在 `USER_CONTEXT_MAP`（ConcurrentHashMap）
- 会议房间使用 `ChannelGroup` 管理
- 支持消息广播（群组）和点对点（私聊）

### 7. 消息中间件模块
**实现类**: `MessageHandler4Redis`, `MessageHandler4Rabbitmq`  
**功能**:
- ✅ 支持 Redis Pub/Sub 模式
- ✅ 支持 RabbitMQ Fanout 模式
- ✅ 消息重试机制（RabbitMQ）
- ✅ 可配置切换（通过 `messaging.handle.channel` 配置）

**关键实现**:
- 使用 `@ConditionalOnProperty` 实现条件加载
- RabbitMQ 支持消息重试（最多3次）
- Redis 使用 Redisson 客户端

---

## 🛠️ 工具类模块

### 1. 媒体处理工具
**类**: `FFmpegUtils`  
**功能**:
- ✅ 图片格式统一（转为 JPG）
- ✅ 视频格式转换（转为 MP4，支持 HEVC 编码）
- ✅ 图片缩略图生成
- ✅ 视频封面提取

### 2. 进程执行工具
**类**: `ProcessUtils`  
**功能**:
- ✅ 执行系统命令（支持 Windows/Linux）
- ✅ 命令执行结果获取
- ✅ 异常处理

### 3. 其他工具类
- `SnowFlakeUtils`: 雪花算法 ID 生成
- `DateUtil`: 日期格式化工具
- `StringTools`: 字符串工具（MD5、随机字符串等）
- `JsonUtils`: JSON 序列化/反序列化
- `TableSplitUtils`: 表分片工具（按月分表）
- `CopyTools`: 对象拷贝工具
- `ArrayUtils`: 数组工具

---

## ⚙️ 配置与基础设施

### 1. 数据库配置
- **数据库**: MySQL 8.0.23
- **连接池**: HikariCP
- **ORM**: MyBatis 1.3.2
- **表分片**: 聊天消息表按月分表

### 2. 缓存配置
- **Redis**: Spring Data Redis + Redisson
- **用途**: 
  - Token 存储
  - 会议成员状态
  - 验证码存储
  - 系统配置

### 3. 消息队列配置
- **支持**: Redis Pub/Sub 或 RabbitMQ
- **配置项**: `messaging.handle.channel=redis|rabbitmq`

### 4. WebSocket 配置
- **框架**: Netty 4.1.50
- **端口**: 6061（可配置）
- **协议**: WebSocket

### 5. 文件存储配置
- **存储路径**: `project.folder`（可配置）
- **目录结构**:
  - `file/{YYYYMM}/`: 按月份存储文件
  - `file/avatar/`: 用户头像
  - `temp/`: 临时文件

---

## 🔐 安全与认证

### 1. 认证机制
- **Token 认证**: 基于 Redis 存储
- **Token 生成**: MD5(userId + 随机字符串)
- **Token 过期**: 24小时

### 2. 权限控制
- **全局拦截器**: `GlobalInterceptor`
- **功能**:
  - 登录验证（`checkLogin`）
  - 管理员验证（`checkAdmin`）
- **AOP 切面**: `GlobalOperationAspect`

### 3. 异常处理
- **全局异常处理器**: `AGlobalExceptionHandlerController`
- **支持异常类型**:
  - 业务异常（`BusinessException`）
  - 参数验证异常
  - 数据库异常（主键冲突等）
  - 404 异常

---

## 📊 数据模型

### 核心实体
1. **UserInfo**: 用户信息
2. **MeetingInfo**: 会议信息
3. **MeetingReserve**: 预约会议
4. **MeetingMember**: 会议成员
5. **MeetingChatMessage**: 聊天消息
6. **UserContact**: 用户联系人
7. **UserContactApply**: 好友申请

### 枚举类型
- `UserStatusEnum`: 用户状态（启用/禁用）
- `MeetingStatusEnum`: 会议状态
- `MeetingMemberStatusEnum`: 成员状态
- `MessageTypeEnum`: 消息类型（12种）
- `FileTypeEnum`: 文件类型（图片/视频）
- `ReceiveTypeEnum`: 接收类型（个人/群组）

---

## 🐛 已修复的问题

### 1. 视频封面生成
- **问题**: 视频上传时错误调用图片缩略图方法
- **修复**: 新增 `createVideoCover` 方法，从视频提取封面帧

### 2. 强制下线功能
- **问题**: `cleanCheckCode` 方法调用错误
- **修复**: 改为 `cleanTokenByUserId`

### 3. 临时文件清理
- **问题**: 头像上传后临时文件未删除
- **修复**: 在方法结束时清理临时文件

### 4. RabbitMQ 模块
- **问题**: 
  - 未使用的导入
  - 拼写错误（`MAX_RETAYTIMES` → `MAX_RETRY_TIMES`）
  - `sendMessage` 中 `factory` 可能为 null
- **修复**: 已全部修复

### 5. WebSocket 连接断开
- **问题**: TODO 注释未清理，缺少空指针检查
- **修复**: 完善连接断开逻辑，增加空指针检查

---

## ⚠️ 潜在问题与建议

### 1. 代码质量
- ✅ **已修复**: 大部分关键问题已修复
- ⚠️ **建议**: 
  - 增加单元测试覆盖率
  - 统一异常处理规范
  - 增加日志记录（关键操作）

### 2. 性能优化
- ⚠️ **建议**:
  - 文件上传使用异步处理
  - 大文件分片上传
  - Redis 连接池优化
  - 数据库查询优化（索引检查）

### 3. 安全性
- ⚠️ **建议**:
  - Token 刷新机制
  - 文件上传类型验证（防止恶意文件）
  - SQL 注入防护（MyBatis 参数化查询已支持）
  - XSS 防护

### 4. 配置管理
- ⚠️ **建议**:
  - 敏感信息使用环境变量或配置中心
  - 生产环境配置分离
  - 配置项验证

### 5. 监控与运维
- ⚠️ **建议**:
  - 增加健康检查接口
  - 增加性能监控（APM）
  - 日志集中管理
  - 告警机制

---

## 📝 配置文件说明

### application.properties
```properties
# 服务端口
server.port=6060
ws.port=6061

# 数据库配置
spring.datasource.url=jdbc:mysql://...
spring.datasource.username=root
spring.datasource.password=123456

# Redis 配置
spring.redis.host=127.0.0.1
spring.redis.port=6379

# 消息处理方式（redis/rabbitmq）
messaging.handle.channel=redis

# RabbitMQ 配置
rabbitmq.host=localhost
rabbitmq.port=5672

# 项目文件目录
project.folder=f:/webser/web_app/easymeeting/

# 管理员邮箱
admin.emails=test@qq.com
```

---

## 🚀 启动流程

1. **应用启动**: `EasymeetingApplication.main()`
2. **初始化组件**:
   - MyBatis Mapper 扫描
   - Redis 连接初始化
   - WebSocket 服务器启动（`InitRun`）
   - 消息监听启动（Redis/RabbitMQ）

3. **WebSocket 启动**:
   - Netty 服务器启动（端口 6061）
   - 消息处理器初始化
   - 连接管理器初始化

---

## 📦 依赖管理

### 核心依赖
- Spring Boot: 2.7.18
- MyBatis: 1.3.2
- MySQL Connector: 8.0.23
- Netty: 4.1.50.Final
- Redisson: 3.12.3
- RabbitMQ Client: 5.14.2
- FastJSON: 1.2.66
- Lombok: 1.18.30

---

## ✅ 项目完成度评估

### 已完成功能 ✅
- [x] 用户注册/登录/管理
- [x] 会议创建/加入/退出
- [x] 预约会议
- [x] 实时聊天（文本/媒体）
- [x] 文件上传/下载
- [x] 好友管理
- [x] WebSocket 实时通信
- [x] 消息中间件（Redis/RabbitMQ）
- [x] 管理员功能
- [x] 媒体处理（图片/视频）

### 代码质量 ✅
- [x] 异常处理完善
- [x] 全局拦截器
- [x] AOP 切面
- [x] 统一响应格式
- [x] 代码规范

### 待优化项 ⚠️
- [ ] 单元测试
- [ ] 性能优化
- [ ] 安全加固
- [ ] 监控告警
- [ ] 文档完善

---

## 📌 总结

**EasyMeeting** 是一个功能完整的在线视频会议系统，采用 Spring Boot + Netty + Redis/RabbitMQ 技术栈实现。项目架构清晰，模块划分合理，核心功能已全部实现。

**主要亮点**:
1. ✅ 支持实时视频会议（WebRTC + WebSocket）
2. ✅ 完整的用户和会议管理
3. ✅ 多媒体消息支持（图片/视频）
4. ✅ 灵活的消息中间件选择（Redis/RabbitMQ）
5. ✅ 完善的异常处理和权限控制

**项目状态**: 🟢 **可投入使用**

---

*报告生成时间: 2024年*  
*项目版本: 1.0*

